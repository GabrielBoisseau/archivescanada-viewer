var handlebars=require("handlebars"),openseadragon=require("openseadragon"),manifesto=require("manifesto.js"),getUserLocale=require("get-user-locale");!function(d,o,i,h){"use strict";var r,n="harmonizedViewer",a={locale:"en-GB",manifest:null,navigation:{enableCustomScrollbar:!0}};function t(e,t){this.element=e,this.settings=d.extend({},a,t),this._defaults=a,this._name=n,this.displayMode=1,this.manifest=null,this.currentPage=0,this.pages=[],this.carousel=null,this.init()}d.extend(t.prototype,{init:function(){this.events={},this.configureLocales(),alert(this.localeString("display_mode_single_page")),this.initToolbar(),this.loadManifest();var n=this;this.bindEventControls("page"),this.bindEventControls("previous"),this.bindEventControls("next"),this.bindEventControls("navigation"),this.bindEventControls("metadata"),this.bindEventControls("gallery"),this.bindEventControls("display"),this.addHandler("navigation",function(){n.toggleSidebar(".hv-sidebar__navigation")}),this.addHandler("gallery",function(){n.toggleSidebar(".hv-overlay__gallery")}),this.addHandler("metadata",function(){n.toggleSidebar(".hv-sidebar__metadata")}),this.addHandler("display",function(e){var t=parseInt(e.displayMode);n.displayMode=1===t||2===t?t:1,n.initOpenSeadragon()}),this.addHandler("previous",function(){n.goTo(n.currentPage-n.displayMode)}),this.addHandler("next",function(){n.goTo(n.currentPage+n.displayMode)}),this.addHandler("page",function(){n.enableNavigationPrevious(n.isFirstPage()),n.enableNavigationNext(n.isLastPage());var e=d(n.element).find(".hv-navigation__item--active");n.scrollTo(e)}),this.addHandler("loaded",function(){n.getViewport().removeClass("loading"),d(r.element).show(),n.showToolbars(),n.enableToolbar(".hv-toolbar__secondary")})},configureLocales:function(){},populateAnnotations:function(){var e=this.getSidebar(".hv-sidebar__metadata"),t=d("<div/>").addClass("hv-sidebar-content").appendTo(e),n=d("<dl/>").addClass("hv-annotations").appendTo(t);d.each(this.manifest.getMetadata(),function(e,t){d("<dt/>").text(t.getLabel()).appendTo(n),d("<dd/>").html(t.getValue()).appendTo(n),n.append(n)})},populateNavigation:function(){var a=this,t=this.getSidebar(".hv-sidebar__navigation"),e=this.getSidebar(".hv-overlay__gallery"),n=t.find(".hv-navigation__items"),i=e.find(".hv-navigation__items"),o=[];this.manifest.getSequenceByIndex(0).getCanvases().forEach(function(e){var t=e.getImages()[0],n=e.getLabel()[0],i=a.getThumbnail(t,h,120);o.push({title:n.value,imageUrl:i})});var r=d("<ol/>");o.forEach(function(e,t){var n=d("<li/>").attr("data-index",t).appendTo(r),i=d("<a/>").attr("href","javascript:;").addClass("hv-navigation__item").attr("title",e.title).attr("data-toggle","page").attr("data-page",t).appendTo(n);a.createThumbnail(e.imageUrl).appendTo(i)}),n.html(r[0].outerHTML),i.html(r[0].outerHTML),t.mCustomScrollbar({skin:"dark-think",scrollInertia:0,keyboard:{enable:!1},advanced:{autoScrollOnFocus:".hv-navigation__item"}}),e.mCustomScrollbar({skin:"dark-think",scrollInertia:0,keyboard:{enable:!1},advanced:{autoScrollOnFocus:".hv-navigation__item"}});var s=d(this.element).find(".hv-navigation__carousel .swiper-wrapper");o.forEach(function(e){var t=d("<li/>").addClass("swiper-slide").css({width:"90px",height:"90px"}).appendTo(s);a.createThumbnail(e.imageUrl).appendTo(t)}),this.carousel=new Swiper(".hv-navigation__carousel",{slidesPerView:"auto",centeredSlides:!0,slidesPerColumnFill:"row",spaceBetween:3}),this.initLazyLoading();var l={trigger:"hover focus",placement:"bottom",template:'<div class="tooltip hv-tooltip" role="tooltip"><div class="tooltip-inner"></div></div>'};t.find(".hv-navigation__item").tooltip(l),e.find(".hv-navigation__item").tooltip(l),t.keydown(function(e){switch(e.which){case 37:case 38:t.find(".hv-navigation__item:focus").parent().prev().children(".hv-navigation__item").eq(0).focus();break;case 39:case 40:t.find(".hv-navigation__item:focus").parent().next().children(".hv-navigation__item").eq(0).focus();break;default:return}e.preventDefault()})},goTo:function(e){e<0?console.error("Page index must be equal to or greater than zero."):e>this.pages.length-1?console.error("Page index must be less than the total number of pages."):(this.currentPage=e,this.initOpenSeadragon(),this.raiseEvent("page",{page:e}))},isFirstPage:function(){return this.currentPage<this.displayMode},isLastPage:function(){return this.currentPage>=this.pages.length-1-(this.displayMode-1)},getThumbnail:function(e,t,n){var i=e.getResource().getServices()[0];return this.format("{0}/full/{1},{2}/0/default.{3}",i.id,t!==h?t:"",n!==h?n:"","jpg")},bindProperty:function(e,t){d(this.element).find("[data-bind]").filter(function(){return-1<d(this).attr("data-bind").toLowerCase().indexOf(e.toLowerCase())}).text(t).removeClass("hv-skeleton")},getContent:function(){return d(this.element).find(".hv-content")},getViewport:function(){return d(this.element).find(".hv-viewport")},getSidebar:function(e){return d(this.element).find(e)},openSidebar:function(e){var t=this.getSidebar(e).removeClass("hv-sidebar--closing hv-sidebar--closed hv-sidebar--opened").addClass("hv-sidebar--opening");t.hasClass("hv-sidebar__right")||t.hasClass("hv-sidebar__top")||t.hasClass("hv-sidebar__bottom");t.addClass("hv-sidebar--opened"),this.resizeViewport()},closeSidebar:function(e){var t=this.getSidebar(e).removeClass("hv-sidebar--opening hv-sidebar--opened hv-sidebar--closed").addClass("hv-sidebar--closing");t.hasClass("hv-sidebar__right")||t.hasClass("hv-sidebar__top")||t.hasClass("hv-sidebar__bottom");t.addClass("hv-sidebar--closed"),this.resizeViewport()},isSidebarOpened:function(e){var t=this.getSidebar(e);return t.hasClass("hv-sidebar--opened")||t.hasClass("hv-sidebar--opening")},resizeViewport:function(){var e=this.caculateSidebarWidth(".hv-sidebar.hv-sidebar__push.hv-sidebar__left"),t=this.caculateSidebarWidth(".hv-sidebar.hv-sidebar__push.hv-sidebar__right");this.getContent().find(".hv-content__container").css("padding-left",this.format("{0}px",e)).css("padding-right",this.format("{0}px",t))},caculateSidebarWidth:function(e){var t=this,n=0;return d(this.element).find(e).each(function(){t.isSidebarOpened(this)&&(n+=d(this).outerWidth())}),n},toggleSidebar:function(e){this.isSidebarOpened(e)?this.closeSidebar(e):this.openSidebar(e)},enableButton:function(e,t){void 0===t&&(t=!0),d(this.element).find(e).prop("disabled",!t)},disableButton:function(e,t){return this.enableButton(e,!1)},showToolbars:function(){d(this.element).find(".hv-toolbar__secondary.invisible").removeClass("invisible")},initToolbar:function(){d(this.element).on("click",".hv-button-toggle",function(){d(this).toggleClass("hv-button-toggle--active")}),d(this.element).append(Handlebars.partials["modal-settings"]()).find(".modal").modal({autofocus:!1,detachable:!0,blurring:!0}),d(this.element).find(".hv-modal_settings .ui.dropdown").dropdown(),d(this.element).on("click",".hv-menu_settings",function(){d(".hv-modal_settings").modal("show")})},enableToolbar:function(e,t){void 0===t&&(t=!0),d(this.element).find(e).find(".hv-button").prop("disabled",!t)},disableToolbar:function(e){this.enableToolbar(e,!1)},scrollTo:function(e){var t=this.getSidebar(".hv-sidebar__navigation");this.settings.navigation.enableCustomScrollbar?t.mCustomScrollbar("scrollTo",d(e)):d(e)[0].scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},enableNavigation:function(e){this.enableNavigationPrevious(e),this.enableNavigationNext(e)},disableNavigation:function(){return this.enableNavigation(!1)},enableNavigationPrevious:function(e){var t=this.getViewport().find(".hv-viewport__prev");return this.enableButton(t,e)},disableNavigationPrevious:function(){return enableNavigationPrevious(!1)},enableNavigationNext:function(e){var t=this.getViewport().find(".hv-viewport__next");return this.enableButton(t,e)},disableNavigationNext:function(){return enableNavigationNext(!1)},updateNavigationControls:function(){var e=r.currentPage();this.getEventControls("previous").prop("disabled",this.isFirstPage()),this.getEventControls("next").prop("disabled",this.isLastPage()),d(this.element).find(".hv-sidebar__navigation ol > li .hv-navigation__item").removeClass("hv-navigation__item--active"),d(this.element).find(".hv-sidebar__navigation ol > li[data-index="+e+"] .hv-navigation__item").addClass("hv-navigation__item--active")},getManifestCanvas:function(e){return this.manifest.getSequenceByIndex(0).getCanvasByIndex(e)},bindEventControls:function(e,t){var n=this;d(i).find(this.element).on("click","[data-toggle="+e+"]",function(){n.raiseEvent(e,d(this).data())})},getEventControls:function(e){return d(this.element).find("[data-toggle="+e+"]")},raiseEvent:function(e,t){var n=this.getHandler(e);n&&n(this,t=t||{})},addHandler:function(e,t,n){var i=this.events[e];i||(this.events[e]=i=[]),t&&"function"==typeof t&&(i[i.length]={handler:t,userData:n||null})},getHandler:function(e){var a=this.events[e];return a&&a.length?(a=1===a.length?[a[0]]:Array.apply(null,a),function(e,t){var n,i=a.length;for(n=0;n<i;n++)a[n]&&(t.eventSource=e,t.userData=a[n].userData,a[n].handler(t))}):null},createThumbnail:function(e){return d("<img/>").attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==").addClass("hv-thumbnail hv-lazy").attr("data-src",e).attr("data-srcset",this.format("{0} 1x",e))},initOpenSeadragon:function(){var a=this;r!==h&&(r.destroy(),r=null);var e=this.getViewport();e.find(".hv-openseadragon").remove();var t=d("<div/>").addClass("hv-openseadragon").hide().width("100%").height("100%").appendTo(e),n=this.getUniqueId(t[0]),i=a.pages.slice(a.currentPage,a.currentPage+a.displayMode);(r=new OpenSeadragon({id:n,prefixUrl:"../node_modules/openseadragon/build/openseadragon/images/",tileSources:i,sequenceMode:!1,collectionMode:!0,collectionRows:1,collectionColumns:1,collectionLayout:"horizontal",collectionTileMargin:30,showNavigator:!0,navigatorPosition:"BOTTOM_RIGHT",showNavigationControl:!1,showSequenceControl:!1,minZoomImageRatio:1,preserveViewport:!0,animationTime:.25,springStiffness:10})).addHandler("open",function(e){a.raiseEvent("loaded",e)}),r.addHandler("page",function(e){}),r.addHandler("tile-loaded",function(e){a.raiseEvent("tile-loaded",e)}),r.addHandler("open-failed",function(e){d(r.element).hide(),a.showError(e)}),r.addHandler("animation",function(){var e=r.viewport.getMinZoom(),t=r.viewport.getMaxZoom(),n=r.viewport.getZoom(!1),i=Math.round(100*(n-e)/(t-e),0);d(a.element).find(".hv-zoom").text(a.format("{0}%",i))})},loadManifest:function(){var t=this;manifesto.loadManifest(this.settings.manifest).then(function(e){t.manifest=manifesto.create(e),t.manifest.getSequences()[0].getCanvases().map(function(e){return e.getImages()[0].getResource().getServices()[0].id+"/info.json"}).forEach(function(e){t.pages.push(e)}),t.bindProperty("manifest-label",t.manifest.getDefaultLabel()),t.bindProperty("total-pages",t.pages.length),t.initOpenSeadragon()},function(e){console.error(e),t.showError(e)}).catch(function(e){console.error(e),t.showError(e.message)})},initPageSlider:function(){var e=this.manifest.getSequenceByIndex(0).getCanvases().length,t=d(this.element).find(".hv-pageslider")[0];noUiSlider.create(t,{start:[1],step:1,range:{min:[1],max:[e]},behaviour:"hover-snap"});var i=this;d(t).hover(function(){},function(){d(".hv-tooltip").remove()}),d(t).mousemove(function(e){i.setSliderTooltipPosition(t,{x:e.pageX,y:e.pageY})}),t.noUiSlider.on("hover",function(e){var t=parseInt(e)-1;i.updateSliderPreview(t)}),t.noUiSlider.on("slide",function(e,t){var n=parseInt(e[t])-1;i.updateSliderPreview(n)}),t.noUiSlider.on("end",function(e,t){})},setSliderTooltipPosition:function(e,t){var n=d(".hv-tooltip"),i=d(e).offset().top,a=d(o).height()-i;n.css({bottom:a,left:t.x-n.outerWidth()/2})},updateSliderPreview:function(e){var t=this.getManifestCanvas(e).getImages(0)[0],n=this.getThumbnail(t,h,120);if(0===d(".hv-tooltip").length){var i=d("<div/>").addClass("hv-tooltip animated bounceIn2 faster").attr("role","tooltip").appendTo("body"),a=(d("<div/>").addClass("arrow").appendTo(i),d("<div/>").addClass("tooltip-inner").appendTo(i));d("<img/>").addClass("hv-thumbnail").appendTo(a)}d(".hv-tooltip").find("img").one("load",function(){d(".hv-tooltip").find(".arrow").css({left:d(this).width()/2})}).attr("src",n)},getLocale:function(){return alert(getUserLocale.getUserLocales()),o.localStorage.getItem("locale")||o.navigator.language||o.navigator.userLanguage},resolveLocale:function(t){if("undefined"==typeof harmonizedviewer_locales)return null;void 0===t&&(t=this.getLocale());var e=harmonizedviewer_locales.filter(function(e){return e.code===t&&null!==e.code});if(0<e.length)return e[0];if(t.indexOf("-")){var n=t.substring(0,t.indexOf("-"));return this.resolveLocale(n)}},localeString:function(e){return this.resolveLocale().strings[e]},getUniqueId:function(e){var t=d(e).attr("id");if(t)return t;var n=6,i="0123456789abcdef".split("");n=n||Math.floor(Math.random()*i.length);for(var a="",o=0;o<n;o++)a+=i[Math.floor(Math.random()*i.length)];var r=this.format("#{0}",a);return 0==d(r).length?(d(e).attr("id",a),a):this.getUniqueId(e)},format:function(e){for(var t=0;t<arguments.length-1;t++){var n=new RegExp("\\{"+t+"\\}","gi");e=e.replace(n,arguments[t+1])}return e},showError:function(e){var t=d("<div />").addClass("hv-error ui negative message");d("<div/>").addClass("header").html("Oops...").appendTo(t),d("<p/>").html("Something went wrong. Please try again later.").appendTo(t);var n=this.getViewport();n.removeClass("loading"),t.appendTo(n)},animate:function(e,t,n){var i=d(this.element).find(e);i.addClass("animated").addClass(t),i[0].addEventListener("animationend",function e(){i.removeClass("animated").removeClass(t),i[0].removeEventListener("animationend",e),"function"==typeof n&&n()})},initLazyLoading:function(){var e=[].slice.call(i.querySelectorAll(".hv-lazy"));if(d(e).addClass("hv-lazy--pending"),"IntersectionObserver"in o){var n=new IntersectionObserver(function(e,t){e.forEach(function(e){if(e.isIntersecting){var t=e.target;t.src=t.dataset.src,t.srcset=t.dataset.srcset,t.classList.remove("hv-lazy--pending"),t.classList.add("hv-lazy--loaded"),n.unobserve(t)}})});e.forEach(function(e){n.observe(e)})}}}),d.fn.harmonizedViewer=function(e){return this.each(function(){d.data(this,"plugin_"+n)||d.data(this,"plugin_"+n,new t(this,e))})}}(jQuery,window,document),harmonizedviewer_locales=[{code:"en",strings:{name:"English",display_mode_single_page:"Single page",display_mode_dual_page:"Dual page"}},{code:"fr",strings:{name:"Français",display_mode_single_page:"Single page",display_mode_dual_page:"Dual page"}}],Handlebars.registerPartial("modal-settings",Handlebars.template({compiler:[7,">= 4.0.0"],main:function(e,t,n,i,a){return'<div class="hv-modal_settings ui small modal">\r\n    <div class="header">\r\n        Settings\r\n    </div>\r\n    <div class="content">\r\n        <div class="ui grid">\r\n            <div class="two column row">\r\n                <div class="eight wide column">\r\n                    <h5 class="ui small header">Language</h5>\r\n                    <p>\r\n                        Choose your preferred language for the Harmonized Viewer\'s interface.\r\n                    </p>\r\n                </div>\r\n                <div class="eight wide column">\r\n                    <div class="ui fluid selection dropdown">\r\n                        <i class="dropdown icon"></i>\r\n                        <div class="default text">\r\n                            Select a language\r\n                        </div>\r\n                        <div class="menu">\r\n                            <div class="item" data-value="en">\r\n                                <i class="gb uk flag"></i>\r\n                                English\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n    <div class="actions">\r\n        <div class="ui black deny button">\r\n            Cancel\r\n        </div>\r\n        <div class="ui positive right button">\r\n            Apply\r\n        </div>\r\n    </div>\r\n</div>'},useData:!0}));